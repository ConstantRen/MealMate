<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthy Food Landing Page</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <div class="logo">LOGO</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="recipe.html">Recipe Discovery</a></li>
                <li><a href="nutritionPlan.html">Nutrition Tracking / Meal Plan</a></li>
                <li><a href="signIN.html">Sign Up</a></li>
            </ul>
        </nav>
    </header>

    <section class="main-content">
        <div class="text-section">
            <h1>Change Your Relationship With Food For Good</h1>
            <p>Diet Culture Isnâ€™t Going To Disrupt Itself</p>
            <p>Transform the way you think about food and build a healthier, more balanced relationship for life.</p>
            <button>Get Started</button>
        </div>
        <div class="line2"></div>
        <div class="recipe-section"></div> <!-- Dynamic recipe section -->
    </section>

    <script>
        // Function to get query parameters from URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Get the date from the URL when the page loads
        const selectedDate = getQueryParam('date');

        document.addEventListener('DOMContentLoaded', () => {
            if (selectedDate) {
                console.log(`Selected date: ${selectedDate}`);
            } else {
                console.error('No date selected.');
            }
        });

        // Function to fetch recipes from the server
        async function fetchRecipes() {
            try {
                const response = await fetch('/recipe');
                if (!response.ok) throw new Error('Failed to fetch recipes');

                const recipes = await response.json();
                const recipeSection = document.querySelector('.recipe-section');
                recipeSection.innerHTML = ''; // Clear existing content

                if (recipes.length === 0) {
                    recipeSection.innerHTML = '<p>No recipes available at the moment.</p>';
                    return;
                }

                recipes.forEach(recipe => {
                    const recipeCard = document.createElement('div');
                    recipeCard.className = 'recipe-card';
                    recipeCard.setAttribute('data-recipe-id', recipe._id); // Ensure the recipe ID is correctly assigned

                    const imageSrc = recipe.image ? recipe.image : '/images/placeholder.png';

                    recipeCard.innerHTML = `
                        <img src="${imageSrc}" alt="${recipe.title}" class="recipe-image">
                        <h3>${recipe.title}</h3>
                        <p>Cuisine: ${recipe.cuisine}</p>
                    `;

                    recipeSection.appendChild(recipeCard);
                });
            } catch (error) {
                console.error('Error fetching recipes:', error);
            }
        }

        // Function to add a selected recipe to the meal plan
        async function addRecipeToMealPlan(recipeId) {
    try {
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('userId');
        const selectedDate = new URLSearchParams(window.location.search).get('date');

        console.log('Token:', token);
        console.log('User ID:', userId);
        console.log('Selected Date:', selectedDate);
        console.log('Recipe ID:', recipeId);

        if (!selectedDate) {
            console.error('Date is required but not provided.');
            return; // Stop execution if date is missing
        }

        // Fetch existing meal plan
        const mealPlanResponse = await fetch(`http://localhost:5000/mealPlan?date=${selectedDate}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        let mealPlan = await mealPlanResponse.json();

        // If mealPlan exists, update; otherwise, create a new one
        const mealPlanId = mealPlan && mealPlan._id ? mealPlan._id : null;

        if (!mealPlanId) {
            // Create a new meal plan
            const newMealPlanResponse = await fetch('http://localhost:5000/mealPlan', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date: selectedDate, recipeIds: [recipeId], userId: userId })
            });

            console.log('Request Body:', { date: selectedDate, recipeIds: [recipeId], userId: userId }); // Log request body

            if (newMealPlanResponse.ok) {
                console.log('Meal plan created and recipe added.');
            } else {
                const errorData = await newMealPlanResponse.json();
                console.error('Failed to create meal plan:', errorData);
            }
        } else {
            // Update the existing meal plan
            const response = await fetch(`http://localhost:5000/mealPlan/${mealPlanId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ recipeIds: [...mealPlan.recipeIds, recipeId] })
            });

            if (response.ok) {
                console.log('Recipe added to meal plan.');
            } else {
                const errorData = await response.json();
                console.error('Failed to update meal plan:', errorData);
            }
        }
    } catch (error) {
        console.error('Error adding recipe to meal plan:', error);
    }
}
        document.addEventListener('DOMContentLoaded', () => {
            const recipeSection = document.querySelector('.recipe-section');

            // Delegated event listener for dynamically added recipe cards
            recipeSection.addEventListener('click', function (e) {
                if (e.target && e.target.closest('.recipe-card')) {
                    const recipeCard = e.target.closest('.recipe-card');
                    const recipeId = recipeCard.getAttribute('data-recipe-id');
                    console.log('Selected Recipe ID:', recipeId); // Add this line for debugging

                    if (recipeId) {
                        addRecipeToMealPlan(recipeId);
                    } else {
                        console.error('Recipe ID is undefined.');
                    }
                }
            });

            // Fetch recipes after the DOM is loaded
            fetchRecipes();
        });
    </script>
</body>
</html>
